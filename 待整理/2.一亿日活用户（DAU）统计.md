> (1) 亿级用户场景，如何高性能统计日活？
>
> (2) 如何实现亿级数据统计？
>
> (3) 亿级用户日活统计，有几种方案？

## 业务场景

日活跃用户数量(Daily Active User，DAU)是用于反映网站、互联网应用或网络游戏的运营情况的统计指标。

日活跃用户数量通常统计一日（统计日）之内，登录或使用了某个产品的用户数（去除重复登录的用户）。

受统计方式限制，互联网行业使用的日均活跃用户数指在统计周期(周/月)内，该App的每日活跃用户数的平均值。

## 实现方案

分析，假定一亿活跃用户，则基本内存占用会达到100M * n的级别，n为每个用户ID所占用的空间，若使用无符号整型作为用户ID，则内存用量会达到400M。

1. set、hash：无论使用哪一种，两者内存用量都不会比上述内存用量低，可以可以考虑用Redis中的set和dict实现，不过在Redis中如此大的key输出bigkey，会对redis整体性能有影响。

2. bitmap：若正好用户id采用无符号整型，过着经过处理后能唯一映射到一位整数，且没有哈希碰撞，则可以考虑使用位图进行统计，每个用户活跃状态使用一位二进制表示，1表示活跃，计算1的数量即可。
3. hyperloglog：通用方案，使用hyperloglog算法预估整体活跃用户数量，整体误差可小至1%。

## 方案选择

1. 不会允许bigkey问题
2. 需要精确统计使用方案二
3. 无需精确统计使用方案三





## Big Key的危害？

1、阻塞请求

Big Key对应的value较大，我们对其进行读写的时候，需要耗费较长的时间，这样就可能阻塞后续的请求处理。Redis的核心线程是单线程，单线程中请求任务的处理是串行的，前面的任务完不成，后面的任务就处理不了。

2、内存增大

读取Big Key耗费的内存比正常Key会有所增大，如果不断变大，可能会引发 OOM（内存溢出），或达到redis的最大内存maxmemory设置值引发写阻塞或重要Key被逐出。

3、阻塞网络

读取单value较大时会占用服务器网卡较多带宽，自身变慢的同时可能会影响该服务器上的其他Redis实例或者应用。

4、影响主从同步、主从切换

删除一个大Key造成主库较长时间的阻塞并引发同步中断或主从切换。